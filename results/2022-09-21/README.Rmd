---
title: "Beast v2.6.3"
author: "Mar Llaberia-Robledillo"
date: "21/9/2022"
output: html_document
---

# BEAST v2.6.3

To run BEAST, you must first prepare the `XML` input file. This file is created by BEAUTi (Bayesian Evolutionary Analysis Utility), a graphical software program that allows the creation of `XML` input files. There are six panels in BEAUti (Partitions, Tip Dates, Site Model, Clock Model, Priors and MCMC), each of which contain multiple parameters that can be configured. It also create and open template files which only contain settings of a particular model. This template can be used later for a longer MCMC run, or for a different data set.

The BEAUTi input is a NEXUS (`.nex`) or FASTA (`.fasta`) file with the alignment data.

In our case, the panels and ts parameters that has been modified and adapted to our alignment were:

-   **Site Model** `<Gamma Site Model>`
    -   Substitution Rate `<estimate>`
    -   Subst Model `<GTR>` (the same for iqtree)
-   **Clock Model** `<Strict Clock>`
-   **Priors** (where we add a new prior described below)
    -   Tree.t: `<Coalescent Constant Population>`
    -   clockRate.c `<Uniform>`
    -   freqParameter.s `<Uniform>`
    -   popSize.t `<1/X>`
    -   rateAC.s `<Gamma>`
    -   rateAG.s `<Gamma>`
    -   rateAT.s `<Gamma>`
    -   rateCG.s `<Gamma>`
    -   rateGT.s `<Gamma>`
    -   arc.prior `<Normal> <monophyletic>`
        -   *Mean* `<0.0>`
        -   *Sigma* `<1000.0>`
        -   *Offset* `<8000.0>`
-   **MCMC**
    -   Chain Length `<200000000>`
    -   Store Every `<-1>`
    -   Pre Burnin `<0>`
    -   Num initialization Attempts `<10>`

With these specifications, we save the file as `XML`. Then, we run BEAST.

```{bash}
beast -java -threads 8 cortree.xml
```


# TRACER in R 

```{r}
library(tracerer)
setwd("C:/Users/Mar/Desktop/cor_tree")

# Parse that log file # needs the full path 
beast_log_full <- parse_beast_tracelog_file("C:/Users/Mar/Desktop/cor_tree/cortree.log")

```

```{r, collapse=TRUE}
library(ggplot2)

## ------------------------- 25% Burn-in ---------------------------------------
log25 <- remove_burn_ins(beast_log_full, burn_in_fraction = 0.25)

# Calculates the effective sample sizes of all parameter estimates
estim <- calc_summary_stats_traces(log25, sample_interval = 1000)
ess <- calc_esses(log25, sample_interval = 1000)
ess[, c(1,2,5,17)]
### Posterior 
summary((log25$posterior))
est <- ggplot(log25) + geom_histogram(aes(posterior), binwidth = 10) # estimates
dens <- ggplot(log25) + geom_density(aes(posterior)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log25) + geom_point(aes(Sample, posterior)) # Trace

```

```{r, collapse=TRUE}

### Likelihood 
summary((log25$likelihood))
est <- ggplot(log25) + geom_histogram(aes(likelihood), binwidth = 10) # estimates
dens <- ggplot(log25) + geom_density(aes(likelihood)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log25) + geom_point(aes(Sample, likelihood)) # Trace

```

```{r, collapse=TRUE}

### Tree Height 
summary((log25$TreeHeight))
est <- ggplot(log25) + geom_histogram(aes(TreeHeight), binwidth = 10) # estimates
dens <- ggplot(log25) + geom_density(aes(TreeHeight)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log25) + geom_point(aes(Sample, TreeHeight)) # Trace

```

```{r, collapse=TRUE}

### Coalescent Constant
summary((log25$CoalescentConstant))
est <- ggplot(log25) + geom_histogram(aes(CoalescentConstant), binwidth = 10) # estimates
dens <- ggplot(log25) + geom_density(aes(CoalescentConstant)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log25) + geom_point(aes(Sample, CoalescentConstant)) # Trace

```



```{r, collapse=TRUE}
library(ggplot2)

## ------------------------- 50% Burn-in ---------------------------------------
log50 <- remove_burn_ins(beast_log_full, burn_in_fraction = 0.5)

# Calculates the effective sample sizes of all parameter estimates
estim <- calc_summary_stats_traces(log50, sample_interval = 1000)
ess <- calc_esses(log50, sample_interval = 1000)
ess[, c(1,2,5,17)]
### Posterior 
summary((log50$posterior))
est <- ggplot(log50) + geom_histogram(aes(posterior), binwidth = 10) # estimates
dens <- ggplot(log50) + geom_density(aes(posterior)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log50) + geom_point(aes(Sample, posterior)) # Trace

```

```{r, collapse=TRUE}

### Likelihood 
summary((log50$likelihood))
est <- ggplot(log50) + geom_histogram(aes(likelihood), binwidth = 10) # estimates
dens <- ggplot(log50) + geom_density(aes(likelihood)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log50) + geom_point(aes(Sample, likelihood)) # Trace

```

```{r, collapse=TRUE}

### Tree Height 
summary((log50$TreeHeight))
est <- ggplot(log50) + geom_histogram(aes(TreeHeight), binwidth = 10) # estimates
dens <- ggplot(log50) + geom_density(aes(TreeHeight)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log50) + geom_point(aes(Sample, TreeHeight)) # Trace

```

```{r, collapse=TRUE}

### Coalescent Constant
summary((log50$CoalescentConstant))
est <- ggplot(log50) + geom_histogram(aes(CoalescentConstant), binwidth = 10) # estimates
dens <- ggplot(log50) + geom_density(aes(CoalescentConstant)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log50) + geom_point(aes(Sample, CoalescentConstant)) # Trace

```


```{r, collapse=TRUE}
library(ggplot2)

## ------------------------- 75% Burn-in ---------------------------------------
log75 <- remove_burn_ins(beast_log_full, burn_in_fraction = 0.75)

# Calculates the effective sample sizes of all parameter estimates
estim <- calc_summary_stats_traces(log75, sample_interval = 1000)
ess <- calc_esses(log75, sample_interval = 1000)
ess[, c(1,2,5,17)]
### Posterior 
summary((log75$posterior))
est <- ggplot(log75) + geom_histogram(aes(posterior), binwidth = 10) # estimates
dens <- ggplot(log75) + geom_density(aes(posterior)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log75) + geom_point(aes(Sample, posterior)) # Trace

```

```{r, collapse=TRUE}

### Likelihood 
summary((log75$likelihood))
est <- ggplot(log75) + geom_histogram(aes(likelihood), binwidth = 10) # estimates
dens <- ggplot(log75) + geom_density(aes(likelihood)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log75) + geom_point(aes(Sample, likelihood)) # Trace

```

```{r, collapse=TRUE}

### Tree Height 
summary((log75$TreeHeight))
est <- ggplot(log75) + geom_histogram(aes(TreeHeight), binwidth = 10) # estimates
dens <- ggplot(log75) + geom_density(aes(TreeHeight)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log75) + geom_point(aes(Sample, TreeHeight)) # Trace

```

```{r, collapse=TRUE}

### Coalescent Constant
summary((log75$CoalescentConstant))
est <- ggplot(log75) + geom_histogram(aes(CoalescentConstant), binwidth = 10) # estimates
dens <- ggplot(log75) + geom_density(aes(CoalescentConstant)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log75) + geom_point(aes(Sample, CoalescentConstant)) # Trace

```


```{r, collapse=TRUE}
library(ggplot2)

## ------------------------- 90% Burn-in ---------------------------------------
log90 <- remove_burn_ins(beast_log_full, burn_in_fraction = 0.90)

# Calculates the effective sample sizes of all parameter estimates
estim <- calc_summary_stats_traces(log90, sample_interval = 1000)
ess <- calc_esses(log90, sample_interval = 1000)
ess[, c(1,2,5,17)]

### Posterior 
summary((log90$posterior))
est <- ggplot(log90) + geom_histogram(aes(posterior), binwidth = 10) # estimates
dens <- ggplot(log90) + geom_density(aes(posterior)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log90) + geom_point(aes(Sample, posterior)) # Trace

```

```{r, collapse=TRUE}

### Likelihood 
summary((log90$likelihood))
est <- ggplot(log90) + geom_histogram(aes(likelihood), binwidth = 10) # estimates
dens <- ggplot(log90) + geom_density(aes(likelihood)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log90) + geom_point(aes(Sample, likelihood)) # Trace

```

```{r, collapse=TRUE}

### Tree Height 
summary((log90$TreeHeight))
est <- ggplot(log90) + geom_histogram(aes(TreeHeight), binwidth = 10) # estimates
dens <- ggplot(log90) + geom_density(aes(TreeHeight)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log90) + geom_point(aes(Sample, TreeHeight)) # Trace

```

```{r, collapse=TRUE}

### Coalescent Constant
summary((log90$CoalescentConstant))
est <- ggplot(log90) + geom_histogram(aes(CoalescentConstant), binwidth = 10) # estimates
dens <- ggplot(log90) + geom_density(aes(CoalescentConstant)) # marginal density
gridExtra::grid.arrange(est, dens, ncol = 1)
#---
ggplot(log90) + geom_point(aes(Sample, CoalescentConstant)) # Trace

```


























